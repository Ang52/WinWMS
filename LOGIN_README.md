# WinWMS 登录功能说明

## 功能概述

WinWMS 系统现已集成完整的用户登录和权限管理功能。系统支持两种用户角色：

- **管理员 (Admin)**: 拥有系统的所有权限
- **操作员 (Operator)**: 拥有部分权限，无法访问管理员专属功能

## 默认测试账户

系统预设了两个测试账户供您快速体验：

### 管理员账户
- **用户名**: `admin`
- **密码**: `123456`
- **权限**: 
  - ✅ 入库管理
  - ✅ 出库管理
  - ✅ 库存查询
  - ✅ 入库查询
  - ✅ 出库查询
  - ✅ 月度报表
  - ✅ 物料管理
  - ✅ 仓库管理
  - ✅ 用户管理

### 操作员账户
- **用户名**: `operator`
- **密码**: `123456`
- **权限**:
  - ✅ 入库管理
  - ✅ 出库管理
  - ✅ 库存查询
  - ✅ 入库查询
  - ✅ 出库查询
  - ✅ 月度报表
  - ❌ 物料管理（仅管理员）
  - ❌ 仓库管理（仅管理员）
  - ❌ 用户管理（仅管理员）

## 初始化测试用户

在首次使用系统前，请执行以下SQL脚本来创建测试用户：

```sql
-- 在MySQL中执行以下SQL（或运行 SQL/test_users.sql 文件）
INSERT INTO users (username, password_hash, role, created_at) 
VALUES 
('admin', '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92', 'Admin', NOW()),
('operator', '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92', 'Operator', NOW())
ON DUPLICATE KEY UPDATE 
    password_hash = VALUES(password_hash),
    role = VALUES(role);
```

## 登录界面特性

### 视觉效果
- 🎨 **主题色系**: 采用粉色系主题，与系统整体风格保持一致
- ✨ **动态粒子背景**: 登录窗口背景带有动态移动的粒子效果和连接线动画
- 🎯 **圆角按钮**: 登录按钮采用圆角设计，提升视觉美观度
- 🌈 **悬停效果**: 鼠标悬停时按钮颜色会动态变化

### 交互体验
- ⌨️ **快捷键支持**: 
  - 用户名输入框按 `Enter` 自动跳转到密码框
  - 密码输入框按 `Enter` 直接提交登录
- 🔒 **密码隐藏**: 密码输入时显示为圆点，保护隐私
- ⚠️ **友好提示**: 输入错误时提供清晰的错误提示信息

## 权限控制说明

### 1. 菜单按钮可见性
系统会根据登录用户的角色自动显示/隐藏相应的功能按钮：
- 操作员登录时，物料管理、仓库管理和用户管理按钮将自动隐藏
- 管理员登录时，所有功能按钮都可见

### 2. 状态栏显示
窗口底部的状态栏会显示当前登录用户的信息：
```
当前用户：admin [管理员] | WinWMS v2.0 | .NET 8.0 | 李易远
```

### 3. 操作记录追踪
所有的入库和出库操作都会自动记录操作员信息：
- 入库记录表 (inbound_records) 的 `user_id` 字段
- 出库记录表 (outbound_records) 的 `user_id` 字段

## 安全说明

### 密码加密
- 系统使用 **SHA256** 哈希算法存储密码
- 数据库中只保存密码的哈希值，不存储明文密码
- 建议：生产环境中应使用更安全的 BCrypt 或 Argon2 算法

### 会话管理
- 用户登录信息存储在 `UserSession` 静态类中
- 退出系统时会自动清空会话信息
- 每次启动程序都需要重新登录

## 修改密码

### 方法1：通过用户管理界面（管理员）
1. 使用管理员账户登录
2. 点击左侧菜单的"👥 用户管理"
3. 选择要修改密码的用户
4. 输入新密码后点击"更新"

### 方法2：直接执行SQL（数据库管理员）
```sql
-- 计算新密码的哈希值（假设新密码是 "newpassword123"）
SELECT SHA2('newpassword123', 256);

-- 更新用户密码（将上面生成的哈希值替换到下面的语句中）
UPDATE users 
SET password_hash = '生成的哈希值' 
WHERE username = '用户名';
```

### 在线SHA256哈希生成工具
您也可以使用在线工具生成密码哈希：
- https://emn178.github.io/online-tools/sha256.html
- 输入您的密码，复制生成的256位哈希值
- 使用UPDATE语句更新到数据库

## 注销与退出

点击左侧菜单底部的 "🚪 退出系统" 按钮将：
1. 清空当前用户会话信息
2. 关闭主窗口
3. 返回到登录界面（如果再次运行程序）

## 故障排查

### 无法登录？
1. **检查数据库连接**: 确保 `DbHelper.cs` 中的连接字符串正确
2. **检查用户是否存在**: 在数据库中查询 `SELECT * FROM users;`
3. **检查密码哈希**: 确保数据库中存储的是正确的SHA256哈希值

### 提示"用户名或密码错误"？
1. 确认用户名和密码的大小写（系统区分大小写）
2. 确认是否已执行 `test_users.sql` 脚本创建测试用户
3. 检查数据库中 `password_hash` 字段的值是否正确

### 登录后某些功能看不到？
- 这是正常的权限控制行为
- 使用 `operator` 账户登录时，管理功能会被隐藏
- 请使用 `admin` 账户登录以访问所有功能

## 开发者信息

如需自定义登录功能，请参考以下文件：
- `LoginForm.cs` - 登录窗体逻辑
- `LoginForm.Designer.cs` - 登录窗体界面设计
- `UserSession.cs` - 用户会话管理
- `Program.cs` - 程序入口（登录流程控制）
- `Form1.cs` - 主窗体权限控制

---

**提示**: 首次部署系统时，请务必修改默认密码以确保系统安全！
