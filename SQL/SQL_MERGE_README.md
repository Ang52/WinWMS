# SQL 脚本合并说明

## 合并内容

已将 `test_users.sql` 和 `WMS_DB_Test.sql` 合并为一个完整的数据库初始化脚本。

## 主要变更

### 1. 用户数据整合
- ✅ 移除了旧的 BCrypt 哈希用户数据
- ✅ 使用 SHA256 哈希（与登录系统一致）
- ✅ 统一密码为 `123456`
- ✅ 保留了两个测试账户：
  - `admin` (管理员) - ID: 1
  - `operator` (操作员) - ID: 2

### 2. 表结构优化
- ✅ 更新了 `users` 表的注释，标明使用 SHA256 而非 BCrypt
- ✅ 为入库和出库记录表添加了索引（user_id, date）
- ✅ 为批次表添加了日期索引

### 3. 测试数据关联
- ✅ 确保所有入库/出库记录都关联到有效的用户ID
- ✅ 记录中明确标注是由哪个用户（管理员/操作员）执行的操作

### 4. 增强的输出信息
- ✅ 脚本执行后显示详细的初始化结果
- ✅ 列出所有测试账户及其权限
- ✅ 显示当前库存概况
- ✅ 显示安全提示和文档链接

## 使用方法

### 方法1：MySQL 命令行
```bash
mysql -u root -p < SQL/WMS_DB_Test.sql
```

### 方法2：MySQL Workbench
1. 打开 MySQL Workbench
2. 连接到您的 MySQL 服务器
3. 打开 `SQL/WMS_DB_Test.sql` 文件
4. 点击执行（⚡图标）

### 方法3：使用数据库管理工具
```bash
# 如果已经在 MySQL 中
source SQL/WMS_DB_Test.sql;
```

## 执行后验证

脚本执行成功后，您将看到以下输出：

### 1. 初始化状态
```
✅ 数据库初始化成功！
- 数据库名称: winwms
- 测试用户: 2 个用户 (admin/operator)
- 默认密码: 所有密码: 123456
- 基础数据: 7 种物料, 2 个仓库
- 测试数据: 4 条入库记录, 1 条出库记录
```

### 2. 测试账户
| 用户名 | 角色 | 权限说明 | 密码 |
|--------|------|----------|------|
| admin | Admin | ✅ 全部权限 | 123456 |
| operator | Operator | ⚠️ 部分权限（无管理功能） | 123456 |

### 3. 库存概况
显示当前所有物料的库存情况，包括：
- 物料编码、名称、规格
- 所在仓库
- 库存数量、平均单价、库存总额

### 4. 安全提示
- 🔐 生产环境请务必修改默认密码
- 📖 详细使用说明请查看 LOGIN_README.md
- 🔧 手动修改说明请查看 MANUAL_CHANGES_REQUIRED.md

## 数据库结构

### 表清单（按创建顺序）
1. `users` - 用户表（登录认证）
2. `warehouses` - 仓库表
3. `materials` - 物料表
4. `inbound_records` - 入库记录表
5. `outbound_records` - 出库记录表
6. `inventory_batches` - 库存批次表（FIFO）
7. `inventory` - 库存汇总表

### 初始数据统计
- **用户**: 2 个（1 管理员 + 1 操作员）
- **仓库**: 2 个（主仓库A + 备用仓库B）
- **物料**: 7 种（CPU、内存、硬盘、显卡）
- **入库记录**: 4 条
- **出库记录**: 1 条
- **库存批次**: 4 个
- **库存汇总**: 3 条

## 下一步操作

1. **运行此脚本** 初始化数据库
2. **检查 MANUAL_CHANGES_REQUIRED.md** 完成代码中的手动修改
3. **运行 WinWMS 应用程序** 测试登录功能
4. **使用测试账户登录** 验证权限控制

## 注意事项

⚠️ **重要安全提示**
- 此脚本包含 `DROP DATABASE` 命令，会删除现有的 `winwms` 数据库
- 默认密码 `123456` 仅用于开发测试
- 生产环境部署前务必修改所有默认密码
- 建议使用更强的密码哈希算法（如 BCrypt 或 Argon2）

## 密码修改方法

### 生成新的 SHA256 哈希
```sql
-- 在 MySQL 中生成新密码的哈希值
SELECT SHA2('your_new_password', 256);
```

### 更新用户密码
```sql
-- 更新特定用户的密码
UPDATE users 
SET password_hash = 'new_hash_value_here' 
WHERE username = 'admin';
```

## 故障排查

### 脚本执行失败？
1. 检查 MySQL 服务是否运行
2. 确认有足够的权限创建数据库
3. 检查字符集是否支持 utf8mb4

### 外键约束错误？
- 确保按照脚本顺序执行
- 不要手动修改表的创建顺序

### 数据插入失败？
- 检查是否有重复的唯一键
- 确认所有外键引用的记录存在

---

**脚本版本**: 2.0  
**最后更新**: 2024年  
**维护者**: WinWMS 开发团队
