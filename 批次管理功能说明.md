# 📦 批次管理功能说明

## 🎯 问题与解决方案

### 原始问题
入库相同规格的物料但价格不同时（如：1个30元，1个15元），系统会计算加权平均价格（22.5元），导致：
- ❌ 无法区分不同批次的价格
- ❌ 出库时价格不准确
- ❌ 成本核算困难

### 解决方案：批次管理
实现 **批次管理 + 先进先出(FIFO)** 功能：
- ✅ 每次入库创建独立批次
- ✅ 保留每批物料的原始价格
- ✅ 出库时按先进先出原则自动扣减
- ✅ 准确记录实际出库成本

---

## 📊 数据库变更

### 新增表：inventory_batches（库存批次表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 批次ID（主键）|
| material_id | INT | 物料ID |
| warehouse_id | INT | 仓库ID |
| batch_no | VARCHAR(50) | 批次号 |
| quantity | INT | 批次数量 |
| unit_price | DECIMAL(10,2) | 批次单价 |
| total_amount | DECIMAL(15,2) | 批次总金额 |
| inbound_date | DATETIME | 入库日期 |
| inbound_record_id | INT | 入库记录ID |
| remark | VARCHAR(500) | 备注 |

### 批次号格式
`PC + 物料ID(4位) + 仓库ID(2位) + 日期(8位) + 序号(3位)`

**示例：** `PC0001012024122700001`
- `PC` - 批次前缀
- `0001` - 物料ID
- `01` - 仓库ID
- `20241227` - 入库日期
- `00001` - 当天第1批

---

## 🔧 功能实现

### 1️⃣ 入库流程

```
选择物料 → 选择规格 → 选择仓库 → 输入数量和单价 → 确认入库
    ↓
1. 创建入库记录（inbound_records）
2. 生成批次号并创建批次记录（inventory_batches）
3. 更新库存汇总（inventory，使用加权平均价）
```

**示例：**
```sql
-- 第一次入库：螺丝 M8x20，数量1，单价30元
批次号: PC0001012024122700001
批次数量: 1
批次单价: 30.00

-- 第二次入库：螺丝 M8x20，数量1，单价15元  
批次号: PC0001012024122700002
批次数量: 1
批次单价: 15.00

-- 库存表（汇总）
总数量: 2
平均单价: 22.50
```

### 2️⃣ 出库流程（先进先出 FIFO）

```
选择物料 → 选择规格 → 选择仓库 → 输入数量 → 确认出库
    ↓
1. 查询可用批次（按入库日期升序）
2. 逐批次扣减库存
3. 计算实际出库平均价格
4. 创建出库记录
5. 更新库存汇总
```

**示例：**
```
需要出库：2个螺丝
可用批次：
  - 批次1: 1个 @ 30元（2024-12-27 入库）
  - 批次2: 1个 @ 15元（2024-12-27 入库）

出库结果：
  - 从批次1扣减：1个 @ 30元
  - 从批次2扣减：1个 @ 15元
  - 出库总金额：45元
  - 平均单价：22.50元
```

---

## 📝 安装步骤

### 步骤1：创建批次表
执行 SQL 脚本创建批次管理表：

```bash
mysql -u WinWMS -p winwms < add_batch_management.sql
```

### 步骤2：编译运行
代码已自动更新，直接编译运行即可：

```bash
dotnet build
dotnet run
```

### 步骤3：测试功能

#### 测试入库
1. 打开入库界面
2. 选择物料：螺丝
3. 选择规格：M8x20
4. 选择仓库：主仓库
5. 输入数量：1，单价：30
6. 点击确认入库
7. **查看提示中的批次号**

#### 测试出库
1. 打开出库界面
2. 选择相同物料和仓库
3. 输入出库数量
4. 点击确认出库
5. **查看提示中的平均单价和出库金额**

---

## 🔍 批次查询

### 查询所有批次
```sql
SELECT * FROM v_inventory_batches;
```

### 查询特定物料的批次
```sql
SELECT 
    batch_no AS '批次号',
    quantity AS '数量',
    unit_price AS '单价',
    inbound_date AS '入库日期'
FROM inventory_batches ib
INNER JOIN materials m ON ib.material_id = m.id
WHERE m.name = '螺丝' AND m.spec = 'M8x20'
AND ib.quantity > 0
ORDER BY ib.inbound_date ASC;
```

### 查询价格差异
```sql
SELECT 
    m.name AS '物料名称',
    MIN(ib.unit_price) AS '最低价',
    MAX(ib.unit_price) AS '最高价',
    AVG(ib.unit_price) AS '平均价'
FROM inventory_batches ib
INNER JOIN materials m ON ib.material_id = m.id
WHERE ib.quantity > 0
GROUP BY m.id;
```

---

## 💡 使用场景

### 场景1：不同供应商价格不同
- 供应商A：螺丝 30元/个
- 供应商B：螺丝 15元/个
- 系统会分别记录两个批次，出库时按先进先出自动计算

### 场景2：价格波动
- 第一批：铝型材 100元/米（1月）
- 第二批：铝型材 120元/米（3月）
- 出库时自动按入库顺序扣减，准确反映成本

### 场景3：库龄管理
- 查询库龄超过30天的批次
- 优先消耗早期入库的物料
- 避免库存积压

---

## 📈 报表影响

### 月度报表
- **入库汇总**：显示各批次入库的原始价格
- **出库汇总**：显示按FIFO计算的实际出库成本
- **库存汇总**：显示加权平均价格（快速查询）

### 成本核算
- 准确的出库成本
- 真实的库存价值
- 精确的利润计算

---

## ⚠️ 注意事项

### 1. 数据完整性
- 批次表与入库记录关联
- 删除入库记录会级联删除批次
- 删除物料或仓库会级联删除批次

### 2. 库存一致性
- `inventory` 表：快速查询，显示汇总数据
- `inventory_batches` 表：详细记录，用于FIFO计算
- 两者数量必须保持一致

### 3. 历史数据
- 新功能对历史数据兼容
- 旧的出库记录仍可正常查询
- 建议重新入库更新批次信息

---

## 🎉 功能优势

### ✅ 价格追溯
- 每批物料的原始价格都被完整保留
- 可以追溯任何时间点的入库成本

### ✅ 成本准确
- 按先进先出(FIFO)计算出库成本
- 符合会计准则要求
- 真实反映库存价值

### ✅ 库存管理
- 清晰的批次信息
- 库龄分析
- 呆滞库存预警

### ✅ 报表精准
- 入库报表：原始价格
- 出库报表：实际成本
- 库存报表：当前价值

---

## 📞 常见问题

### Q1: 为什么库存表还保留平均价格？
**A:** 为了查询性能。汇总表快速显示总库存，批次表详细记录成本核算。

### Q2: 出库时能手动选择批次吗？
**A:** 当前版本自动按先进先出，未来可扩展手动选择批次功能。

### Q3: 如何查看某个批次的详细信息？
**A:** 使用提供的 SQL 查询或查看 `v_inventory_batches` 视图。

### Q4: 批次号重复怎么办？
**A:** 批次号包含日期和序号，同一天同一物料入库会自动递增序号，不会重复。

---

## 🔄 数据迁移

如果需要为现有库存创建批次记录：

```sql
-- 为现有库存创建初始批次
INSERT INTO inventory_batches (material_id, warehouse_id, batch_no, quantity, unit_price, total_amount, inbound_date)
SELECT 
    material_id,
    warehouse_id,
    CONCAT('PC', LPAD(material_id, 4, '0'), LPAD(warehouse_id, 2, '0'), '20241227001') AS batch_no,
    quantity,
    unit_price,
    total_amount,
    NOW() AS inbound_date
FROM inventory
WHERE quantity > 0;
```

---

## 📚 相关文件

- `add_batch_management.sql` - 创建批次表
- `batch_queries.sql` - 批次查询示例
- `InboundForm.cs` - 入库功能（含批次创建）
- `OutboundForm.cs` - 出库功能（含FIFO扣减）

---

**版本：** v2.0  
**更新日期：** 2024-12-27  
**开发者：** WinWMS Team
